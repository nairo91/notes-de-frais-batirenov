{% extends "base.html" %}

{% block title %}Notes de frais{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- Colonne formulaire -->
  <div class="col-lg-4">
    <div class="card br-card-glass h-100">
      <div class="card-header br-card-header d-flex justify-content-between align-items-center">
        <div>
          <div class="br-pill mb-1">
            Nouvelle note
          </div>
          <h2 class="h5 mb-0 text-white">Saisir une note de frais</h2>
          <small class="text-muted">Champs marquÃ©s * obligatoires.</small>
        </div>

        <!-- Logo dans la colonne gauche -->
        <a href="{{ url_for('expenses') }}" class="app-logo d-inline-flex align-items-center gap-2 text-decoration-none">
          <img src="{{ url_for('static', filename='img/logo-batirenov.png') }}"
               alt="BATI RENOV"
               class="logo-img" />
          <span class="logo-text">BATI RENOV</span>
        </a>
      </div>

      <div class="card-body">
        <form method="post" enctype="multipart/form-data" class="vstack gap-3">

          <div>
            <label class="form-label">Montant TTC (â‚¬) *</label>
            <input type="number" step="0.01" min="0" class="form-control" name="amount" required>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Montant HT (â‚¬)</label>
              <input type="number" step="0.01" min="0" class="form-control" name="amount_ht">
            </div>
            <div class="col-6">
              <label class="form-label">TVA (â‚¬)</label>
              <input type="number" step="0.01" min="0" class="form-control" name="tva_amount">
            </div>
          </div>

          <!-- Date avec petit bouton calendrier -->
          <div>
            <label class="form-label">Date *</label>
            <div class="date-filter-group">
              <input type="date"
                     class="form-control"
                     name="date"
                     id="expense-date"
                     required>
              <button type="button"
        class="date-filter-btn"
        onclick="const expenseDateInput = document.getElementById('expense-date'); if (expenseDateInput && expenseDateInput.showPicker) { expenseDateInput.showPicker(); } else if (expenseDateInput) { expenseDateInput.focus(); }">
  ðŸ—“
</button>

            </div>
          </div>

          <div>
            <label class="form-label">LibellÃ© *</label>
            <input type="text" class="form-control" name="label" placeholder="Ex: DÃ©jeuner client" required>
          </div>

          <div>
            <label class="form-label">Chantier *</label>
            <input type="text" class="form-control" name="chantier" placeholder="Ex: Chantier Dupont" required>
          </div>

          <!-- Moyen de paiement (optionnel) -->
          <div>
            <label class="form-label">Moyen de paiement</label>
            <select class="form-select" name="payment_method">
              <option value="">-- SÃ©lectionner (optionnel) --</option>
              <option value="CB perso">CB perso</option>
              <option value="CB sociÃ©tÃ©">CB sociÃ©tÃ©</option>
              <option value="EspÃ¨ces">EspÃ¨ces</option>
              <option value="Virement">Virement</option>
              <option value="Autre">Autre</option>
            </select>
          </div>

          <!-- Commentaire (optionnel) -->
          <div>
            <label class="form-label">Commentaire</label>
            <textarea class="form-control"
                      name="comment_text"
                      rows="2"
                      placeholder="Informations complÃ©mentaires (optionnel)"></textarea>
          </div>

          <div>
            <label class="form-label">Justificatif (photo ticket / facture)</label>
            <div class="input-group">
              <input type="file" class="form-control" name="receipt" accept="image/*">
              <button type="button" class="btn btn-outline-primary" id="scan-ticket-btn">
                Scanner le ticket
              </button>
            </div>
            <small class="text-muted">
              Le scan tente de remplir automatiquement le montant, la date, le HT et la TVA.
            </small>
          </div>

          <button type="submit" class="btn btn-success w-100 mt-2">
            Enregistrer la note
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Colonne tableau -->
  <div class="col-lg-8">
    <div class="card br-card-glass mb-3">
      <div class="card-header br-card-header">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>
            <div class="br-pill mb-1">
              {% if is_admin %}
                Vue administrateur
              {% else %}
                Mes notes
              {% endif %}
            </div>
            <h2 class="h5 mb-0 text-white">
              {% if is_admin %}
                Toutes les notes de frais
              {% else %}
                Mes notes de frais
              {% endif %}
            </h2>
          </div>

          <!-- Filtres + export -->
          <div class="d-flex flex-wrap gap-2">

            <!-- Date "Du" avec bouton calendrier -->
            <div class="date-filter-group">
              <input type="date"
                     id="filter-date-from"
                     class="form-control form-control-sm"
                     placeholder="Du">
                        <button type="button"
                        class="date-filter-btn"
                        onclick="const filterFromInput = document.getElementById('filter-date-from'); if (filterFromInput && filterFromInput.showPicker) { filterFromInput.showPicker(); } else if (filterFromInput) { filterFromInput.focus(); }">
                  ðŸ—“
                </button>



            </div>

            <!-- Date "Au" avec bouton calendrier -->
            <div class="date-filter-group">
              <input type="date"
                     id="filter-date-to"
                     class="form-control form-control-sm"
                     placeholder="Au">
            <button type="button"
        class="date-filter-btn"
        onclick="const filterToInput = document.getElementById('filter-date-to'); if (filterToInput && filterToInput.showPicker) { filterToInput.showPicker(); } else if (filterToInput) { filterToInput.focus(); }">
  ðŸ—“
</button>


            </div>

            <!-- Filtre chantier -->
            <input type="text"
                   id="filter-chantier"
                   class="form-control form-control-sm"
                   placeholder="Filtrer chantier">

            <button type="button"
                    class="btn btn-outline-primary btn-sm"
                    id="reset-filters-btn">
              RÃ©initialiser
            </button>

            {% if is_admin %}
              <a href="{{ url_for('admin_export_all_now') }}"
                 class="btn btn-outline-primary btn-sm ms-2">
                Exporter tout (CSV)
              </a>
            {% endif %}

          </div>
        </div>
      </div>

      <div class="card-body">

        <div class="d-flex justify-content-end mb-3 gap-2">
          <button type="button" class="btn btn-outline-primary btn-sm" id="sort-date-btn">
            Trier par date
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" id="sort-amount-btn">
            Trier par montant
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="expenses-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Montant TTC</th>
                <th>Montant HT</th>
                <th>TVA</th>
                <th>LibellÃ©</th>
                <th>Chantier</th>
                <th>Moyen de paiement</th>
                <th>Commentaire</th>
                <th>Utilisateur</th>
                <th>Statut</th>
                <th>Justificatif</th>
                {% if is_admin %}
                  <th>Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
            {% for e in expenses %}
              <tr
                data-date="{{ e.date }}"
                data-amount="{{ e.amount }}"
                data-chantier="{{ e.chantier | lower }}"
              >
                <td>{{ e.date }}</td>
                <td>{{ '%.2f'|format(e.amount) }} â‚¬</td>
                <td>
                  {% if e.amount_ht is not none %}
                    {{ '%.2f'|format(e.amount_ht) }} â‚¬
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if e.tva_amount is not none %}
                    {{ '%.2f'|format(e.tva_amount) }} â‚¬
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>{{ e.label }}</td>
                <td class="chantier-cell">{{ e.chantier }}</td>
                <td>
                  {% if e.payment_method %}
                    {{ e.payment_method }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if e.comment_text %}
                    {{ e.comment_text }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>{{ e.user_email }}</td>
                <td>
                  {% if e.status == 'approved' %}
                    <span class="badge bg-success">ValidÃ©e</span>
                  {% elif e.status == 'rejected' %}
                    <span class="badge bg-danger">RefusÃ©e</span>
                  {% else %}
                    <span class="badge bg-secondary">En attente</span>
                  {% endif %}
                </td>
                <td>
                  {% if e.receipt_path %}
                    {% if e.receipt_path.startswith('http') %}
                      <a href="{{ e.receipt_path }}" target="_blank" class="btn btn-link btn-sm text-decoration-none">
                        Voir
                      </a>
                    {% else %}
                      <a href="{{ url_for('uploaded_file', filename=e.receipt_path) }}" target="_blank" class="btn btn-link btn-sm text-decoration-none">
                        Voir
                      </a>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                {% if is_admin %}
                  <td>
                    <form method="post" action="{{ url_for('approve_expense', expense_id=e.id) }}" class="d-inline">
                      <button type="submit" class="btn btn-success btn-sm"
                              {% if e.status == 'approved' %}disabled{% endif %}>
                        âœ“
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('reject_expense', expense_id=e.id) }}" class="d-inline ms-1">
                      <button type="submit" class="btn btn-outline-danger btn-sm"
                              {% if e.status == 'rejected' %}disabled{% endif %}>
                        âœ•
                      </button>
                    </form>
                  </td>
                {% endif %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

        {% if not expenses %}
          <p class="text-muted text-center mb-0">
            Aucune note de frais enregistrÃ©e pour le moment.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='main.js') }}"></script>
{% endblock %}
